<!-- 054fa2e9-cb11-4cf4-95c6-d2f5392e9087 611b03fe-b8dc-4028-92f5-aa8abceccf87 -->
# 存档系统改造计划

本计划旨在重构现有的存档系统，以支持多世界和多人游戏。我们将引入一个顶层的“存档命名空间”，并使用 JSON 文件来管理世界和玩家数据。

## 阶段一：重构存档结构和世界管理

此阶段的目标是建立新的文件夹结构 `saves/[存档名称]/`，并用 `world.index` (JSON) 文件来管理世界列表。

1.  **引入 JSON 库**

    -   我将向项目（可能是 `pom.xml` 或 `build.gradle`）中添加 Google GSON 库，用于处理 JSON 文件的序列化和反序列化。

2.  **创建数据模型**

    -   创建 `WorldMetadata.java` 类，用于存储单个世界的信息，如 `name`, `seed`, `worldTime`。
    -   创建 `WorldIndex.java` 类，它包含一个 `List<WorldMetadata>`，对应 `world.index` 文件的结构。

3.  **创建新的存档管理器**

    -   创建一个新的 `SaveManager.java` 类。它将负责：
        -   列出 `saves` 目录下的所有存档（即所有子文件夹）。
        -   创建新的存档文件夹。
        -   加载和保存指定存档的 `world.index` 文件。

4.  **修改 `WorldManager.java`**

    -   改造此类，使其操作依赖于存档名称。
    -   `loadWorld` 和 `saveWorld` 等方法的签名将更改为 `loadWorld(String saveName, String worldName)`。
    -   内部路径构建逻辑将更新为 `saves/[saveName]/[worldName]_chunk/` 等新格式。
    -   移除旧的 `level.dat` 读写逻辑。

5.  **更新UI界面**

    -   **`SingleplayerMenu.java`**: 菜单将首先显示存档列表。选择存档后，再从该存档的 `world.index` 中读取并显示世界列表。
    -   **`CreateWorldMenu.java`**: 界面将增加一个选项，允许用户选择一个现有存档或创建一个新存档来存放新世界。

## 阶段二：实现玩家数据读写

此阶段我们将实现玩家数据的保存和加载。

1.  **创建玩家数据模型**

    -   创建 `PlayerIndex.java` 类，用于存储玩家数据，如位置、朝向、物品栏、生命值等。

2.  **扩展 `Player.java`**

    -   为 `Player` 类添加方法，用于将其状态捕获到一个 `PlayerIndex` 对象中，以及从 `PlayerIndex` 对象恢复其状态。

3.  **扩展 `SaveManager.java`**

    -   添加方法来处理玩家数据：
        -   `savePlayer(String saveName, UUID playerUUID, Player player)`: 将玩家数据保存到 `saves/[saveName]/players/[UUID].index`。
        -   `loadPlayer(String saveName, UUID playerUUID)`: 从对应的 JSON 文件加载玩家数据。

4.  **集成到 `Game.java`**

    -   在 `Game.java` 的 `loadWorld` 方法中，加载完世界后，调用 `saveManager.loadPlayer(...)` 来恢复玩家状态。
    -   在游戏退出或切换世界时（`cleanupWorld` 方法中），调用 `saveManager.savePlayer(...)` 来保存玩家的进度。

这个方案将逐步替换现有的简单存档机制，为您后续扩展区块和实体存储（第3、4步）打下坚实的基础。

### To-dos

- [ ] 引入 GSON 库来处理 JSON。
- [ ] 创建 SaveManager 和新的数据模型 (WorldIndex, WorldMetadata, PlayerIndex)。
- [ ] 重构 WorldManager 以使用新的存档结构。
- [ ] 更新 SingleplayerMenu 和 CreateWorldMenu 以适应新的存档选择流程。
- [ ] 实现 Player 数据的保存和加载逻辑。
- [ ] 在 Game.java 中集成玩家数据的保存和加载调用。